# Let's discover something about where we run
ifeq ($(OS), Windows_NT)
SYSTEM = win
else
SYSTEM = unix
endif

# Useful directories.
INC_DIR = include
EX_DIR = examples
CPP_EX_DIR = examples/cpp
CPP_EX_PATH = $(subst /,$S,$(CPP_EX_DIR))
JAVA_EX_DIR = examples/java
JAVA_EX_PATH = $(subst /,$S,$(JAVA_EX_DIR))
DOTNET_EX_DIR = examples/dotnet
DOTNET_EX_PATH = $(subst /,$S,$(DOTNET_EX_DIR))
OBJ_DIR = objs
LIB_DIR = lib
BIN_DIR = bin

# Unix specific part.
ifeq ($(SYSTEM),unix)
  OS = $(shell uname -s)
# C++
  ifeq ($(OS),Linux)
    CXX = g++
    LDFLAGS = \
-Wl,-rpath,"\$$ORIGIN" \
-Wl,-rpath,"\$$ORIGIN/../lib64" \
-Wl,-rpath,"\$$ORIGIN/../lib" \
-lz -lrt -lpthread
    LBITS = $(shell getconf LONG_BIT)
    ifeq ($(LBITS),64)
      PORT = Linux64
      ARCH = -DARCH_K8
      NETPLATFORM = anycpu
    else
      PORT = Linux32
      ARCH =
      NETPLATFORM = x86
    endif
    MONO = LD_LIBRARY_PATH=$(LIB_DIR):$(LD_LIBRARY_PATH) mono
    L = .so
  endif # ifeq($(OS),Linux)
  ifeq ($(OS),Darwin) # Assume Mac Os X
    CXX = clang++
    LDFLAGS = \
-Wl,-rpath,@loader_path \
-Wl,-rpath,@loader_path/../lib \
-lz
    PORT = MacOsX64
    ARCH = -DARCH_K8
    NETPLATFORM = x64
    MONO = DYLD_FALLBACK_LIBRARY_PATH=$(LIB_DIR):$(DYLD_LIBRARY_PATH) mono
    L = .dylib
  endif # ifeq($(OS),Darwin)
  CXX_BIN := $(shell command -v $(CXX) 2> /dev/null)
  DEBUG = -O4 -DNDEBUG
  CXXFLAGS = -fPIC -std=c++11 $(DEBUG) \
 -I$(INC_DIR) -I. $(ARCH) -Wno-deprecated \
 -DUSE_CBC -DUSE_CLP -DUSE_BOP -DUSE_GLOP
  LIB_PREFIX = lib
  PRE_LIB = -Llib -Llib64
  CBC_LNK = -lCbcSolver -lCbc -lOsiCbc -lCgl -lClpSolver -lClp -lOsiClp -lOsi -lCoinUtils
  OR_TOOLS_LNK = $(PRE_LIB) -lprotobuf -lglog -lgflags $(CBC_LNK) -lortools
  CVRPTW_LNK = $(PRE_LIB) -lcvrptw_lib -lprotobuf -lglog -lgflags -lortools
  DIMACS_LNK = $(PRE_LIB) -ldimacs -lglog -lgflags -lortools
  FAP_LNK = $(PRE_LIB) -lfap -lglog -lgflags -lortools
  OBJ_OUT = -o #
  EXE_OUT = -o #
  O = .o
  E =
# Java
ifneq ($(JAVA_HOME),)
  JAVAC_BIN := $(shell command -v $(JAVA_HOME)/bin/javac 2> /dev/null)
  JAVA_BIN := $(shell command -v $(JAVA_HOME)/bin/java 2> /dev/null)
else
  JAVAC_BIN := $(shell command -v javac 2> /dev/null)
  JAVA_BIN := $(shell command -v java 2> /dev/null)
endif
  JAVAFLAGS = -Djava.library.path=$(LIB_DIR)
  CPSEP = :
# .Net
  DOTNET = dotnet
  DOTNET_BIN := $(shell command -v $(DOTNET) 2> /dev/null)
# Makefile
  S = /
  DEL = rm -f
  MKDIR = mkdir
endif # SYSTEM == unix

# Windows specific part.
ifeq ($(SYSTEM),win)
  ifeq ("$(Platform)", "X64")
    PLATFORM = Win64
  endif
  ifeq ("$(Platform)", "x64")
    PLATFORM = Win64
  endif
  ifeq ("$(PLATFORM)", "Win64")
    PORT = VisualStudio$(VISUAL_STUDIO)-64b
    NETPLATFORM = x64
  else
    PORT = VisualStudio$(VISUAL_STUDIO)-32b
    NETPLATFORM = x86
  endif
  CXX = cl
  # We can't use `where` since it's return all matching pathnames
  # so we ship which.exe and use it
  CXX_BIN := $(shell $(WHICH) $(CXX) 2> NUL)
  DEBUG = /O2 -DNDEBUG
  CXXFLAGS = /EHsc /MD /nologo /D_SILENCE_STDEXT_HASH_DEPRECATION_WARNINGS -nologo $(DEBUG) \
    /D__WIN32__ /DGFLAGS_DLL_DECL= /DGFLAGS_DLL_DECLARE_FLAG= /DGFLAGS_DLL_DEFINE_FLAG= \
    /I$(INC_DIR)\\src\\windows /I$(INC_DIR) /I. \
    -DUSE_CBC -DUSE_CLP -DUSE_BOP -DUSE_GLOP
  LDFLAGS = psapi.lib ws2_32.lib
  LIB_PREFIX =
  OR_TOOLS_LNK = lib\\ortools.lib
  CVRPTW_LNK = lib\\cvrptw_lib.lib lib\\ortools.lib
  DIMACS_LNK = lib\\dimacs.lib lib\\ortools.lib
  FAP_LNK = lib\\fap.lib lib\\ortools.lib
  OBJ_OUT = /Fo
  EXE_OUT = /Fe
  O = .obj
  L = .lib
  E = .exe
# Java
  JAVAC_BIN := $(shell $(WHICH) javac 2> NUL)
  JAVA_BIN := $(shell $(WHICH) java 2> NUL)
  JAVAFLAGS = -Djava.library.path=$(LIB_DIR)
  CPSEP = ;
# .Net
  DOTNET = dotnet
  DOTNET_BIN := $(shell $(WHICH) $(DOTNET) 2> NUL)
# Makefile
  S = \\
  DEL = del
  MKDIR = md
  WHICH = tools$Swin$Swhich.exe
endif # SYSTEM == win

OR_TOOLS_LIBS = $(LIB_DIR)/$(LIB_PREFIX)ortools$L
CVRPTW_LIBS = $(LIB_DIR)/$(LIB_PREFIX)cvrptw_lib$L
DIMACS_LIBS = $(LIB_DIR)/$(LIB_PREFIX)dimacs$L
FAP_LIBS = $(LIB_DIR)/$(LIB_PREFIX)fap$L
CLR_DLL_NAME ?= Google.OrTools

.PHONY: all
all: detect cc java dotnet test

.PHONY: detect
detect: detect_port detect_cc detect_java detect_dotnet

.PHONY: test
test: test_cc test_java test_dotnet

.PHONY: clean
clean:
	-$(DEL) $(EXE)
	-$(DEL) $(BIN_DIR)$S*$E
	-$(DEL) $(OBJ_DIR)$S*$O

.PHONY: detect_port
detect_port:
	@echo SHELL = $(SHELL)
	@echo SYSTEM = $(SYSTEM)
	@echo PORT = $(PORT)
	@echo OS = $(OS)
ifeq ($(SYSTEM),win)
	@echo off & echo(
else
	@echo
endif

###########
##  C++  ##
###########
EXE = \
$(BIN_DIR)/costas_array$E \
$(BIN_DIR)/cryptarithm$E \
$(BIN_DIR)/cvrp_disjoint_tw$E \
$(BIN_DIR)/cvrptw$E \
$(BIN_DIR)/cvrptw_with_breaks$E \
$(BIN_DIR)/cvrptw_with_refueling$E \
$(BIN_DIR)/cvrptw_with_resources$E \
$(BIN_DIR)/cvrptw_with_stop_times_and_resources$E \
$(BIN_DIR)/dimacs_assignment$E \
$(BIN_DIR)/dobble_ls$E \
$(BIN_DIR)/flexible_jobshop$E \
$(BIN_DIR)/golomb$E \
$(BIN_DIR)/jobshop$E \
$(BIN_DIR)/jobshop_ls$E \
$(BIN_DIR)/jobshop_earlytardy$E \
$(BIN_DIR)/magic_square$E \
$(BIN_DIR)/model_util$E \
$(BIN_DIR)/multidim_knapsack$E \
$(BIN_DIR)/network_routing$E \
$(BIN_DIR)/nqueens$E \
$(BIN_DIR)/pdptw$E \
$(BIN_DIR)/sports_scheduling$E \
$(BIN_DIR)/tsp$E \
$(BIN_DIR)/linear_assignment_api$E \
$(BIN_DIR)/strawberry_fields_with_column_generation$E \
$(BIN_DIR)/linear_programming$E \
$(BIN_DIR)/linear_solver_protocol_buffers$E \
$(BIN_DIR)/integer_programming$E \
$(BIN_DIR)/flow_api$E

ifndef CXX_BIN
cc test_cc ccc rcc:
	@echo the $(CXX) command was not found in your PATH
else
cc: $(EXE)

test_cc: detect_cc $(BIN_DIR)/golomb$E $(BIN_DIR)/cvrptw$E
	$(BIN_DIR)$Sgolomb$E
	$(BIN_DIR)$Scvrptw$E

# C++ generic running command
ifeq ($(EX),)
ccc rcc:
	@echo No C++ file was provided, the $@ target must be used like so: \
	make $@ EX=examples/cpp/example.cc
else # ifeq ($(EX),)
ccc: $(BIN_DIR)/$(basename $(notdir $(EX)))$E

rcc: $(BIN_DIR)/$(basename $(notdir $(EX)))$E
	@echo running $<
	$(BIN_DIR)$S$(basename $(notdir $(EX)))$E $(ARGS)
endif # ifeq ($(EX),)
endif # ifndef CXX_BIN

$(OBJ_DIR):
	$(MKDIR) $(OBJ_DIR)

$(OBJ_DIR)/%$O: $(CPP_EX_DIR)/%.cc | $(OBJ_DIR)
	$(CXX) $(CXXFLAGS) -c $(CPP_EX_PATH)$S$*.cc $(OBJ_OUT)$(OBJ_DIR)$S$*$O

$(BIN_DIR)/%$E: $(OBJ_DIR)/%$O
	$(CXX) $(CXXFLAGS) $(OBJ_DIR)$S$*$O $(OR_TOOLS_LNK) $(LDFLAGS) $(EXE_OUT)$(BIN_DIR)$S$*$E

$(BIN_DIR)/cvrp_disjoint_tw$E: $(OBJ_DIR)/cvrp_disjoint_tw$O
	$(CXX) $(CXXFLAGS) $(OBJ_DIR)$Scvrp_disjoint_tw$O $(CVRPTW_LNK) $(LDFLAGS) $(EXE_OUT)$(BIN_DIR)$Scvrp_disjoint_tw$E

$(BIN_DIR)/cvrptw$E: $(OBJ_DIR)/cvrptw$O
	$(CXX) $(CXXFLAGS) $(OBJ_DIR)$Scvrptw$O $(CVRPTW_LNK) $(LDFLAGS) $(EXE_OUT)$(BIN_DIR)$Scvrptw$E

$(BIN_DIR)/cvrptw_with_breaks$E: $(OBJ_DIR)/cvrptw_with_breaks$O
	$(CXX) $(CXXFLAGS) $(OBJ_DIR)$Scvrptw_with_breaks$O $(CVRPTW_LNK) $(LDFLAGS) $(EXE_OUT)$(BIN_DIR)$Scvrptw_with_breaks$E

$(BIN_DIR)/cvrptw_with_refueling$E: $(OBJ_DIR)/cvrptw_with_refueling$O
	$(CXX) $(CXXFLAGS) $(OBJ_DIR)$Scvrptw_with_refueling$O $(CVRPTW_LNK) $(LDFLAGS) $(EXE_OUT)$(BIN_DIR)$Scvrptw_with_refueling$E

$(BIN_DIR)/cvrptw_with_resources$E: $(OBJ_DIR)/cvrptw_with_resources$O
	$(CXX) $(CXXFLAGS) $(OBJ_DIR)$Scvrptw_with_resources$O $(CVRPTW_LNK) $(LDFLAGS) $(EXE_OUT)$(BIN_DIR)$Scvrptw_with_resources$E

$(BIN_DIR)/cvrptw_with_stop_times_and_resources$E: $(OBJ_DIR)/cvrptw_with_stop_times_and_resources$O
	$(CXX) $(CXXFLAGS) $(OBJ_DIR)$Scvrptw_with_stop_times_and_resources$O $(CVRPTW_LNK) $(LDFLAGS) $(EXE_OUT)$(BIN_DIR)$Scvrptw_with_stop_times_and_resources$E

$(BIN_DIR)/dimacs_assignment$E: $(OBJ_DIR)/dimacs_assignment$O
	$(CXX) $(CXXFLAGS) $(OBJ_DIR)$Sdimacs_assignment$O $(DIMACS_LNK) $(LDFLAGS) $(EXE_OUT)$(BIN_DIR)$Sdimacs_assignment$E

.PHONY: detect_cc
detect_cc:
	@echo CXX = $(CXX)
	@echo CXX_BIN = $(CXX_BIN)
	@echo CXXFLAGS = $(CXXFLAGS)
	@echo LDFLAGS = $(LDFLAGS)
	@echo OR_TOOLS_LNK = $(OR_TOOLS_LNK)
	@echo CVRPTW_LNK = $(CVRPTW_LNK)
	@echo DIMACS_LNK = $(DIMACS_LNK)
	@echo FAP_LNK = $(FAP_LNK)
ifeq ($(SYSTEM),win)
	@echo off & echo(
else
	@echo
endif

############
##  JAVA  ##
############
JAR = \
$(OBJ_DIR)/AllDifferentExcept0.class \
$(OBJ_DIR)/AllInterval.class \
$(OBJ_DIR)/CapacitatedVehicleRoutingProblemWithTimeWindows.class \
$(OBJ_DIR)/Circuit.class \
$(OBJ_DIR)/CoinsGrid.class \
$(OBJ_DIR)/CoinsGridMIP.class \
$(OBJ_DIR)/ColoringMIP.class \
$(OBJ_DIR)/CoveringOpl.class \
$(OBJ_DIR)/Crossword.class \
$(OBJ_DIR)/DeBruijn.class \
$(OBJ_DIR)/Diet.class \
$(OBJ_DIR)/DietMIP.class \
$(OBJ_DIR)/DivisibleBy9Through1.class \
$(OBJ_DIR)/FlowExample.class \
$(OBJ_DIR)/GolombRuler.class \
$(OBJ_DIR)/IntegerProgramming.class \
$(OBJ_DIR)/Issue173.class \
$(OBJ_DIR)/Knapsack.class \
$(OBJ_DIR)/KnapsackMIP.class \
$(OBJ_DIR)/LeastDiff.class \
$(OBJ_DIR)/LinearAssignmentAPI.class \
$(OBJ_DIR)/LinearProgramming.class \
$(OBJ_DIR)/LsApi.class \
$(OBJ_DIR)/MagicSquare.class \
$(OBJ_DIR)/Map2.class \
$(OBJ_DIR)/Map.class \
$(OBJ_DIR)/Minesweeper.class \
$(OBJ_DIR)/MultiThreadTest.class \
$(OBJ_DIR)/NQueens2.class \
$(OBJ_DIR)/NQueens.class \
$(OBJ_DIR)/Partition.class \
$(OBJ_DIR)/QuasigroupCompletion.class \
$(OBJ_DIR)/RabbitsPheasants.class \
$(OBJ_DIR)/SendMoreMoney2.class \
$(OBJ_DIR)/SendMoreMoney.class \
$(OBJ_DIR)/SendMostMoney.class \
$(OBJ_DIR)/Seseman.class \
$(OBJ_DIR)/SetCovering2.class \
$(OBJ_DIR)/SetCovering3.class \
$(OBJ_DIR)/SetCovering4.class \
$(OBJ_DIR)/SetCoveringDeployment.class \
$(OBJ_DIR)/SetCovering.class \
$(OBJ_DIR)/SimpleRoutingTest.class \
$(OBJ_DIR)/StableMarriage.class \
$(OBJ_DIR)/StiglerMIP.class \
$(OBJ_DIR)/Strimko2.class \
$(OBJ_DIR)/Sudoku.class \
$(OBJ_DIR)/SurvoPuzzle.class \
$(OBJ_DIR)/ToNum.class \
$(OBJ_DIR)/Tsp.class \
$(OBJ_DIR)/WhoKilledAgatha.class \
$(OBJ_DIR)/Xkcd.class \
$(OBJ_DIR)/YoungTableaux.class

HAS_JAVA = true
ifndef JAVA_BIN
HAS_JAVA =
endif
ifndef JAVAC_BIN
HAS_JAVA =
endif

ifndef HAS_JAVA
java test_java rjava cjava:
	@echo the java or javac command was not found in your PATH
else
java: $(JAR)

test_java: detect_java $(OBJ_DIR)/Tsp.class
	$(JAVA_BIN) $(JAVAFLAGS) \
 -cp $(OBJ_DIR)$(CPSEP)$(LIB_DIR)$Scom.google.ortools.jar$(CPSEP)$(LIB_DIR)$Sprotobuf.jar \
 Tsp

# Java generic compilation command.
ifeq ($(EX),)
rjava cjava:
	@echo No java file was provided, the rjava target must be used like so: \
	make rjava EX=examples/java/example.java
else # ifeq ($(EX),)
cjava: $(OBJ_DIR)/$(basename $(notdir $(EX))).class

rjava: $(OBJ_DIR)/$(basename $(notdir $(EX))).class
	@echo running $<
	$(JAVA_BIN) $(JAVAFLAGS) \
 -cp $(OBJ_DIR)$(CPSEP)$(LIB_DIR)$Scom.google.ortools.jar$(CPSEP)$(LIB_DIR)$Sprotobuf.jar \
 $(basename $(notdir $(EX))) $(ARGS)
endif # ifeq ($(EX),)
endif # ifndef HAS_JAVA

$(OBJ_DIR)/%.class: $(JAVA_EX_DIR)/%.java | $(OBJ_DIR)
	$(JAVAC_BIN) -d $(OBJ_DIR) \
 -cp $(LIB_DIR)$Scom.google.ortools.jar$(CPSEP)$(LIB_DIR)$Sprotobuf.jar \
 $(JAVA_EX_PATH)$S$*.java

.PHONY: detect_java
detect_java:
	@echo JAVAC_BIN = $(JAVAC_BIN)
	@echo JAVA_BIN = $(JAVA_BIN)
	@echo JAVAFLAGS = $(JAVAFLAGS)
ifeq ($(SYSTEM),win)
	@echo off & echo(
else
	@echo
endif

##############
##  DOTNET  ##
##############
ifndef DOTNET_BIN
test_dotnet:
	@echo the $(DOTNET) command was not found in your PATH
else
test_dotnet: detect_dotnet
	$(CSC_BIN) /target:exe /out:$(BIN_DIR)$Scsflow.exe /platform:$(NETPLATFORM) /lib:$(BIN_DIR) /r:Google.OrTools.dll /r:Google.Protobuf.dll $(CS_EX_DIR)$Scsflow.cs
	$(DOTNET_BIN) run $(BIN_DIR)$Scsflow.dll

ifeq ($(EX),)
rcs:
	@echo No csharp file was provided, the rcs target must be used like so: \
	make rcs EX=path/to/the/example/example.cs
else
# .NET generic compilation command.
$(BIN_DIR)$S$(basename $(notdir $(EX))).exe: $(BIN_DIR)/$(CLR_DLL_NAME).dll $(EX)
	$(CSC_BIN) $(SIGNING_FLAGS) /target:exe /out:$(BIN_DIR)$S$(basename $(notdir $(EX))).exe /platform:$(NETPLATFORM) /lib:$(BIN_DIR) /r:$(CLR_DLL_NAME).dll /r:Google.Protobuf.dll $(EX)

csc: $(BIN_DIR)$S$(basename $(notdir $(EX))).exe

rcs: $(BIN_DIR)$S$(basename $(notdir $(EX))).exe
	@echo running $(BIN_DIR)$S$(basename $(notdir $(EX))).exe
	$(MONO) $(BIN_DIR)$S$(basename $(notdir $(EX))).exe $(ARGS)
endif
endif

.PHONY: detect_dotnet
detect_dotnet:
	@echo CSC = $(CSC)
	@echo CSC_BIN = $(CSC_BIN)
	@echo SIGNING_FLAGS = $(SIGNING_FLAGS)
	@echo CLR_DLL_NAME = $(CLR_DLL_NAME)
ifeq ($(SYSTEM),win)
	@echo off & echo(
else
	@echo
endif

############
##  MISC  ##
############
# Include user makefile
-include Makefile.user

print-%	: ; @echo $* = $($*)
